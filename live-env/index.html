<!doctype html>
<html>

<head>
  <meta charset="UTF-8" />
  <title>Strudel Live Environment</title>
  <script src="https://unpkg.com/@strudel/web"></script>
  <style>
    body {
      background: #111;
      color: #eee;
      font-family: monospace;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      /* Changed from center to prevent clipping */
      min-height: 100vh;
      /* Changed from height to min-height */
      margin: 0;
      padding: 20px;
      /* Added padding */
      box-sizing: border-box;
    }

    #status {
      margin-top: 20px;
      color: #888;
    }

    button {
      padding: 10px 20px;
      font-size: 1.2em;
      cursor: pointer;
      background: #333;
      color: white;
      border: 1px solid #555;
      border-radius: 4px;
    }

    button:hover {
      background: #444;
    }

    pre {
      background: #222;
      padding: 20px;
      border-radius: 8px;
      border: 1px solid #444;
    }
  </style>
</head>

<body>
  <h1>Strudel Live Environment</h1>
  <div>
    <select id="file-selector"
      style="padding: 10px; font-size: 1.2em; background: #333; color: white; border: 1px solid #555; border-radius: 4px; margin-right: 10px;">
      <option value="music.js">music.js</option>
      <option value="track1.js">track1.js</option>
      <option value="track2.js">track2.js</option>
      <option value="track3.js">track3.js</option>
      <option value="track4.js">track4.js</option>
      <option value="track5.js">track5.js</option>
      <option value="track6.js">track6.js</option>
      <option value="track7.js">track7.js</option>
      <option value="track8.js">track8.js</option>
      <option value="track9.js">track9.js</option>
    </select>
    <button id="start">Start Audio</button>
    <button id="pause" style="display:none;">Pause</button>
    <button id="play" style="display:none;">Play</button>
    <button id="restart" style="display:none;">Restart</button>
  </div>
  <div id="status">Waiting for audio start...</div>
  <pre id="code-display">// Code will appear here</pre>

  <script>
    let lastCode = '';
    let isStarted = false;
    let isPlaying = false;
    let checkInterval = null;

    async function checkCode() {
      if (!isStarted) return;
      try {
        const filename = document.getElementById('file-selector').value;
        const response = await fetch(filename + '?t=' + Date.now());
        const text = await response.text();
        if (text !== lastCode) {
          lastCode = text;
          document.getElementById('code-display').innerText = text;
          document.getElementById('status').innerText = 'Updated: ' + new Date().toLocaleTimeString();
          if (isPlaying) {
            await strudel.evaluate(text);
          }
        }
      } catch (e) {
        console.error('Error fetching code:', e);
      }
    }

    document.getElementById('start').addEventListener('click', async () => {
      document.getElementById('status').innerText = 'Loading samples...';
      await strudel.initStrudel();

      // Load piano samples from Strudel CDN
      await strudel.samples('https://strudel.b-cdn.net/piano.json', 'https://strudel.b-cdn.net/piano/');
      // Load VCSL samples (for Ocarina, etc.)
      await strudel.samples('https://strudel.b-cdn.net/vcsl.json', 'https://strudel.b-cdn.net/VCSL/');
      // Load drum machine samples (RolandTR808, RolandTR909, etc.)
      await strudel.samples('https://strudel.b-cdn.net/tidal-drum-machines.json', 'https://strudel.b-cdn.net/tidal-drum-machines/machines/');
      // Register General MIDI soundfonts (for gm_acoustic_guitar_nylon etc.)
      try {
        const { registerSoundfonts } = await import('./soundfonts.js');
        registerSoundfonts();
        document.getElementById('status').innerText = 'Samples + GM soundfonts loaded!';
      } catch (e) {
        console.error('Failed to load GM soundfonts', e);
        document.getElementById('status').innerText = 'Samples loaded, but GM soundfonts failed.';
      }
      // Previous status message replaced by the GM soundfonts status above

      // Expose all strudel exports as globals (like the REPL does)
      // This includes pattern generators, functions, and utilities
      Object.keys(strudel).forEach(key => {
        if (typeof strudel[key] !== 'undefined' && key !== 'default') {
          window[key] = strudel[key];
        }
      });

      isStarted = true;
      isPlaying = true;
      document.getElementById('start').style.display = 'none';
      document.getElementById('pause').style.display = 'inline';
      document.getElementById('restart').style.display = 'inline';
      document.getElementById('status').innerText = 'Audio started! Polling for changes...';
      checkCode();
      checkInterval = setInterval(checkCode, 1000);
    });

    document.getElementById('pause').addEventListener('click', () => {
      strudel.hush();
      isPlaying = false;
      document.getElementById('pause').style.display = 'none';
      document.getElementById('play').style.display = 'inline';
      document.getElementById('status').innerText = 'Paused';
    });

    document.getElementById('play').addEventListener('click', async () => {
      if (lastCode) {
        await strudel.evaluate(lastCode);
      }
      isPlaying = true;
      document.getElementById('play').style.display = 'none';
      document.getElementById('pause').style.display = 'inline';
      document.getElementById('status').innerText = 'Playing';
    });

    document.getElementById('restart').addEventListener('click', () => {
      strudel.hush();
      setTimeout(async () => {
        if (lastCode) {
          await strudel.evaluate(lastCode);
        }
        isPlaying = true;
        document.getElementById('play').style.display = 'none';
        document.getElementById('pause').style.display = 'inline';
        document.getElementById('status').innerText = 'Restarted: ' + new Date().toLocaleTimeString();
      }, 100);
    });

    document.getElementById('file-selector').addEventListener('change', () => {
      lastCode = ''; // Force update
      checkCode();
    });
  </script>
</body>

</html>